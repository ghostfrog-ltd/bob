<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GhostFrog 路 Bob &amp; Chad Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="chat.css" />
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-header-left">
        <div class="logo">GF</div>
        <div>
          <div class="title">GhostFrog 路 Bob &amp; Chad Console</div>
          <div class="subtitle">
            Data root: <span style="color:#a5b4fc;">/ai/data</span> 路 Queue: <code>/ai/data/queue</code>
          </div>
        </div>
      </div>
      <div class="tagline">
        <span class="badge">Local</span>
        <span>Bob thinks, Chad writes, you watch.</span>
      </div>
    </header>

    <main id="chat" class="app-body">
      <div class="message-row bot">
        <div class="avatar bot">B</div>
        <div>
          <div class="bubble bot">Welcome..</div>
          <div class="message-meta">Bob 路 ready</div>
        </div>
      </div>
    </main>

    <footer class="app-footer">
      <form id="chat-form" class="input-row">
        <div class="input">
          <input
            id="chat-input"
            type="text"
            autocomplete="off"
            placeholder="Ask for a change, e.g. Make a plan to refactor the alert bot CLI."
          />
        </div>
        <button id="send-btn" class="send-btn" type="submit">
          <span class="send-icon">
0e</span>
          Send
        </button>
      </form>
      <div class="hint">
        Every message creates <span>.user.txt</span>, <span>.plan.json</span>, and <span>.exec.json</span> in
        <code>/ai/data/queue</code>, plus a scratch file in <code>/ai/data/scratch</code>.
      </div>
    </footer>
  </div>

  <script>
    const chatEl = document.getElementById("chat");
    const formEl = document.getElementById("chat-form");
    const inputEl = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");

    function appendMessage(role, text) {
      const row = document.createElement("div");
      row.className = "message-row " + (role === "user" ? "user" : "bot");

      const avatar = document.createElement("div");
      avatar.className = "avatar " + (role === "user" ? "user" : "bot");
      if (role === "user") {
        avatar.textContent = "You";
      } else if (role === "bob") {
        avatar.textContent = "B";
      } else if (role === "chad") {
        avatar.textContent = "C";
      } else {
        avatar.textContent = "b7b7b7";
      }

      const contentWrap = document.createElement("div");
      const bubble = document.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "user" : "bot");
      bubble.textContent = text;

      const meta = document.createElement("div");
      meta.className = "message-meta";
      if (role === "user") {
        meta.textContent = "You";
      } else if (role === "bob") {
        meta.textContent = "Bob";
      } else if (role === "chad") {
        meta.textContent = "Chad";
      } else {
        meta.textContent = "System";
      }

      contentWrap.appendChild(bubble);
      contentWrap.appendChild(meta);

      if (role === "user") {
        row.appendChild(contentWrap);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(contentWrap);
      }

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // Decide if we should reload based on touched_files
    function shouldReloadForTouchedFiles(touchedFiles, taskType) {
      if (!Array.isArray(touchedFiles) || touchedFiles.length === 0) return false;

      // You can tighten or relax this rule as you like
      return touchedFiles.some((f) => {
        if (!f) return false;
        // Directly edited the chat UI
        if (f === "ui/chat_ui.html") return true;
        // Any HTML inside the ui/ folder (layouts, partials, etc.)
        if (f.startsWith("ui/") && f.endsWith(".html")) return true;
        return false;
      });
    }

    async function sendCommand(message) {
      sendBtn.disabled = true;
      appendMessage("bob", "Bob: thinking");

      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await resp.json();

        const msgs = data.messages || [];
        msgs.forEach(m => {
          appendMessage(m.role || "bob", m.text || "");
        });

        const touchedFiles = data.touched_files || [];
        const taskType = data.task_type || "";

        if (shouldReloadForTouchedFiles(touchedFiles, taskType)) {
          // Small delay so you can see Chad's last message before the reload
          setTimeout(() => {
            window.location.reload();
          }, 500);
        }
      } catch (err) {
        appendMessage("bob", "Error talking to Bob/Chad middleware.");
      } finally {
        sendBtn.disabled = false;
      }
    }

    formEl.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = (inputEl.value || "").trim();
      if (!text) return;
      appendMessage("user", text);
      inputEl.value = "";
      sendCommand(text);
    });
  </script>
</body>
</html>
